{% extends "/base/default-page.html" %}

{% block default_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.css') }}">
	<script src="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.js') }}"></script>
{% endblock default_head %}

{% block additional_head %}
<style>
#mapdisplay {
	height: 60vh;
}

#hotspot-date-offset-old {
	direction: rtl;
}

</style>
{% endblock additional_head %}

{% block barecontent %}
<!--
	<div id="mapdisplay"></div>
-->
<!-- for specific date query testing, not final product -->
<!--
<div>
	<input type="date" id="hotspot-date">
	<input type="range" id="hotspot-date-offset" min="0" max="60" value="0">
	<button id="hotspot-query">Get</button>
	<span id="hotspot-info"></span>
</div>
-->
<div class="row">
	<!-- map -->
	<div class="col s9">
		<div id="mapdisplay"></div>
	</div>
	<!-- map controls -->
	<div class="col s3" id="hotspot-controls">
		<form action="#">
			<div class="row input-field">
				<input type="text" class="datepicker" id="hotspot-date" />
				<label class="active" for="hotspot-date">Hotspot Date</label>
			</div>
				<p class="row range-field">
					<input type="range" min="0" max="60" value="60" id="hotspot-date-offset" />
				</p>
			<div class="row">
				<a class="btn" id="hotspot-query">Get Data</a>
			</div>
		</form>
		<span id="hotspot-info"</span>
	</div>
</div>

<script type="text/python">
	from browser import document, window, ajax, bind, timer
	import javascript
	import datetime

	leaflet = window.L
	jq = window.jQuery
	mcss = window.M

	_jsdate_today = javascript.Date.new()

	marker_opts = {
		"stroke": False,
		"radius": 5,
		"color": '#ff8833'
	}

	# set up materialize css stuff
	dp_opts = {
		"setDefaultDate": True,
		"defaultDate": _jsdate_today,
		"format": "yyyy-mm-dd"
	}

	dp_elems = document.querySelectorAll('.datepicker')
	dp_instances = mcss.Datepicker.init(dp_elems, dp_opts)

	lmap = leaflet.map("mapdisplay",{"preferCanvas": True})
	marker_layer = leaflet.LayerGroup.new()
	marker_dated = {}
	fetch_in_progress = False

	def query_ajax(target=None):
		""" send request to server using ajax

			Args: target (string): 
				date to query, formatted to '%Y-%m-%d'
		"""
		data = {}
		if target is not None:
			data = { "date" : target }

		jq.ajax('/hotspots', {
			"dataType": "json",
			"data": data,
			"success": hotspot_get_jq
		})
	
	def change_or_query(target=None):
		""" check if target date is queried before query for new entry
			if already queried, display them instead of query and redraw
			otherwise, proceed to query as normal.

			Args: target (datetime): 
				specifying target date, defaults to today if none provided
		"""
		global fetch_in_progress
		if fetch_in_progress:
			return

		if target is None:
			target = datetime.datetime.today()

		target_jul = target.strftime('%Y%j')
		target_str = target.strftime('%Y-%m-%d')

		if target_jul in marker_dated:
			marker_layer.clearLayers()
			marker_layer.addLayer(marker_dated[target_jul])
			enable_input(True)
		else:
			fetch_in_progress = True
			query_ajax(target_str)

	def enable_input(state=True):
		document['hotspot-date-offset'].disabled = not state
		if state:
			document['hotspot-query'].classList.remove('disabled')
		else:
			document['hotspot-query'].classList.add('disabled')

	# test date input, not final product
	@bind('#hotspot-query', 'click')
	def date_query(ev):
		enable_input(False)
		target_val = document['hotspot-date'].value
		target = datetime.datetime.strptime(target_val, '%Y-%m-%d')
		change_or_query(target)

	@bind('#hotspot-date-offset', 'change')
	def date_query_slider(ev):
		enable_input(False)
		offset = document['hotspot-date-offset'].value
		offset = 60 - int(offset)
		delta = datetime.timedelta(days=offset)
		target = datetime.datetime.today() - delta
		target_str = target.strftime('%Y-%m-%d')

		document['hotspot-date'].value = target_str

		change_or_query(target)


	def draw_all(data, date_jul):
		if date_jul not in marker_dated:
			mkl = leaflet.LayerGroup.new()
			marker_dated[date_jul] = mkl
		else:
			mkl = marker_dated[date_jul]
		
		for spot in data:
			coords = (spot['latitude'], spot['longitude'])
			m = leaflet.circleMarker(coords, marker_opts)
			m.addTo(mkl)
		
		mkl.addTo(marker_layer)
		marker_layer.addTo(lmap)
		document['hotspot-info'].text = ''
		
	def draw_chunks(data, date_jul):
		todo = data.copy()
		chunksize = 200
		chunkdelay = 100

		if date_jul not in marker_dated:
			mkl = leaflet.LayerGroup.new()
			marker_dated[date_jul] = mkl
		else:
			mkl = marker_dated[date_jul]
			enable_input(True)
		
		def dotask():
			items = todo[0:chunksize]

			for spot in items:
				coords = (spot['latitude'], spot['longitude'])
				m = leaflet.circleMarker(coords, marker_opts)
				m.addTo(mkl)
			
			del todo[0:chunksize]

			if len(todo) > 0:
				timer.set_timeout(dotask, chunkdelay)
				load_percent = 1 - (len(todo) / len(data))
				load_str = "Loading {:.1%} ...".format(load_percent)
				document['hotspot-info'].text = load_str
			else:
				enable_input(True)
				document['hotspot-info'].text = ''

		timer.set_timeout(dotask, chunkdelay)
		mkl.addTo(marker_layer)
		marker_layer.addTo(lmap)

	def hotspot_get_jq(resp_data, text_status, jqxhr):
		# resp_data.data is already json
		if resp_data.status == 'success':
			marker_layer.clearLayers()
			document['hotspot-info'].text = 'Loading...'

			data = resp_data.data
			date_jul = resp_data.date_jul

			draw_chunks(data, date_jul)
		else:
			document['hotspot-info'].text = 'Error retrieving hotspots'

		global fetch_in_progress
		fetch_in_progress = False

	# jQuery is somehow way faster
	# get point for today
	def get_point_jq(ev):
		query_ajax()

	lmap.on('load', get_point_jq)

	leaflet.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
		"maxZoom": 18,
		"attribution": '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(lmap)

	lmap.setView([13, 100.8], 6)

	# for browser console debug only
	window.lmap = lmap
	window.marker_layer = marker_layer
</script>
{% endblock barecontent %}
