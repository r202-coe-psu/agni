{% extends "/base/default-page.html" %}

{% block default_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.css') }}">
	<script src="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.js') }}"></script>
{% endblock default_head %}

{% block additional_head %}
<style>
#mapdisplay {
	height: 60vh;
}

#hotspot-date-offset {
	direction: rtl;
}
</style>
{% endblock additional_head %}

{% block content %}
<div id="mapdisplay"></div>

<!-- for specific date query testing, not final product -->
<div>
	<input type="date" id="hotspot-date">
	<input type="range" id="hotspot-date-offset" min="0" max="60" value="0">
	<button id="hotspot-query">Get</button>
	<span id="hotspot-info"></span>
</div>

<script type="text/python">
	from browser import document, window, ajax, bind
	import datetime

	leaflet = window.L
	jq = window.jQuery

	marker_opts = {
		"stroke": False,
		"radius": 6,
		"color": '#ff8833',
	}

	lmap = leaflet.map("mapdisplay",{"preferCanvas": True})
	marker_layer = leaflet.LayerGroup.new()
	marker_dated = {}

	def query_ajax(target=None):
		""" send request to server using ajax

			Args: target (string): 
				date to query, formatted to '%Y-%m-%d'
		"""
		data = {}
		if target is not None:
			data = { "date" : target }

		jq.ajax('/hotspots', {
			"dataType": "json",
			"data": data,
			"success": hotspot_get_jq
		})
	
	def change_or_query(target=None):
		""" check if target date is queried before query for new entry
			if already queried, display them instead of query and redraw
			otherwise, proceed to query as normal.

			Args: target (datetime): 
				specifying target date, defaults to today if none provided
		"""
		if target is None:
			target = datetime.datetime.today()

		target_jul = target.strftime('%Y%j')
		target_str = target.strftime('%Y-%m-%d')

		if target_jul in marker_dated:
			marker_layer.clearLayers()
			marker_layer.addLayer(marker_dated[target_jul])
		else:
			query_ajax(target_str)

	# test date input, not final product
	@bind('#hotspot-query', 'click')
	def date_query(ev):
		target_val = document['hotspot-date'].value
		target = datetime.datetime.strptime(target_val, '%Y-%m-%d')
		change_or_query(target)

	@bind('#hotspot-date-offset', 'change')
	def date_query_slider(ev):
		offset = document['hotspot-date-offset'].value
		delta = datetime.timedelta(days=int(offset))
		target = datetime.datetime.today() - delta
		target_str = target.strftime('%Y-%m-%d')

		document['hotspot-date'].value = target_str

		change_or_query(target)

	def hotspot_get_jq(resp_data, text_status, jqxhr):
		# resp_data.data is already json
		if resp_data.status == 'success':
			marker_layer.clearLayers()
			document['hotspot-info'].text = ''

			mkl = leaflet.LayerGroup.new()
			date_jul = resp_data.date_jul
			marker_dated[date_jul] = mkl

			data = resp_data.data
			for spot in data:
				coords = (spot['latitude'], spot['longitude'])
				m = leaflet.circleMarker(coords, marker_opts)
				m.addTo(mkl)
				mkl.addTo(marker_layer)
				marker_layer.addTo(lmap)
		else:
			document['hotspot-info'].text = 'Error retrieving hotspots'

	# jQuery is somehow way faster
	# get point for today
	def get_point_jq(ev):
		query_ajax()

	lmap.on('load', get_point_jq)

	leaflet.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
		"maxZoom": 18,
		"attribution": '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(lmap)

	lmap.setView([13, 100.8], 6)

	# for browser console debug only
	window.lmap = lmap
	window.marker_layer = marker_layer
</script>
{% endblock content %}
